<div class="patient-http-dashboard">
  <div class="section">
    <div class="header-with-button">
      <h2><%= t('patient_http.title') %></h2>
      <form action="<%= root_path %>patient-http/clear" method="post" class="clear-stats-form">
        <%= csrf_tag %>
        <button type="submit" class="btn btn-danger" onclick="return confirm('<%= t('patient_http.clear_confirm') %>');">
          <%= t('patient_http.clear_stats') %>
        </button>
      </form>
    </div>

    <div class="patient-http-stats">
      <!-- Summary Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label"><%= t('patient_http.total_requests') %></div>
          <div class="stat-value"><%= number_with_delimiter(total_requests) %></div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><%= t('patient_http.total_errors') %></div>
          <div class="stat-value error"><%= number_with_delimiter(totals['errors'] || 0) %></div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><%= t('patient_http.max_capacity_exceeded') %></div>
          <div class="stat-value"><%= number_with_delimiter(totals['max_capacity_exceeded'] || 0) %></div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><%= t('patient_http.average_duration') %></div>
          <div class="stat-value">
            <span><%= avg_duration %></span>
          </div>
        </div>
      </div>

      <!-- Capacity Information -->
      <div class="capacity-section">
        <h3><%= t('patient_http.connection_capacity') %></h3>
        <div class="capacity-cards">
          <div class="capacity-card">
            <div class="capacity-label"><%= t('patient_http.max_capacity') %></div>
            <div class="capacity-value"><%= number_with_delimiter(max_capacity) %></div>
            <div class="capacity-unit"><%= t('patient_http.connections') %></div>
          </div>
          <div class="capacity-card">
            <div class="capacity-label"><%= t('patient_http.currently_inflight') %></div>
            <div class="capacity-value"><%= number_with_delimiter(current_inflight) %></div>
            <div class="capacity-unit"><%= t('patient_http.requests') %></div>
          </div>
          <div class="capacity-card">
            <div class="capacity-label"><%= t('patient_http.capacity_utilization') %></div>
            <div class="capacity-value"><%= utilization %>%</div>
            <div class="capacity-unit"><%= t('patient_http.used') %></div>
          </div>
        </div>

        <!-- Process Breakdown -->
        <div class="process-breakdown">
          <h4><%= t('patient_http.per_process_details') %></h4>
          <table class="table">
            <thead>
              <tr>
                <th><%= t('patient_http.process') %></th>
                <th><%= t('patient_http.inflight') %></th>
                <th><%= t('patient_http.max_capacity') %></th>
                <th><%= t('patient_http.utilization') %></th>
              </tr>
            </thead>
            <tbody>
              <% if processes.empty? %>
                <tr class="empty-state">
                  <td colspan="4"><%= t('patient_http.no_active_processes') %></td>
                </tr>
              <% else %>
                <% processes.each do |process_id, info| %>
                  <% utilization = info[:max_capacity] > 0 ? (info[:inflight].to_f / info[:max_capacity] * 100).round(1) : 0 %>
                  <tr>
                    <td><%= h(process_id) %></td>
                    <td><%= number_with_delimiter(info[:inflight]) %></td>
                    <td><%= number_with_delimiter(info[:max_capacity]) %></td>
                    <td><%= utilization %>%</td>
                  </tr>
                <% end %>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- HTTP Status Codes Breakdown -->
      <% http_status_counts = totals['http_status_counts'] || {} %>
      <% unless http_status_counts.empty? %>
        <div class="breakdown-section">
          <h3><%= t('patient_http.http_status_codes') %></h3>
          <table class="table">
            <thead>
              <tr>
                <th><%= t('patient_http.status_code') %></th>
                <th><%= t('patient_http.count') %></th>
              </tr>
            </thead>
            <tbody>
              <% http_status_counts.sort.each do |status, count| %>
                <tr>
                  <td><%= status %></td>
                  <td><%= number_with_delimiter(count) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>

      <!-- Error Types Breakdown -->
      <% error_type_counts = totals['error_type_counts'] || {} %>
      <% unless error_type_counts.empty? %>
        <div class="breakdown-section">
          <h3><%= t('patient_http.error_types') %></h3>
          <table class="table">
            <thead>
              <tr>
                <th><%= t('patient_http.error_type') %></th>
                <th><%= t('patient_http.count') %></th>
              </tr>
            </thead>
            <tbody>
              <% error_type_counts.sort_by { |_, count| -count }.each do |error_type, count| %>
                <tr>
                  <td><%= h(error_type) %></td>
                  <td><%= number_with_delimiter(count) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </div>
</div>

<% style_tag("patient-http/css/patient_http.css") %>
