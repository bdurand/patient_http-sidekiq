<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inspect Responses - Sidekiq AsyncHttp</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div id="toast" class="toast"></div>

  <div class="container">
    <h1>Inspect Responses</h1>

    <form id="inspect-form">
      <div class="form-group">
        <label for="url">URL</label>
        <input
          type="text"
          id="url"
          name="url"
          value="/time"
          autocomplete="off"
        >
        <div class="help-text">Request URL path or full URL</div>
      </div>

      <div class="form-group">
        <label for="method">HTTP Method</label>
        <select id="method" name="method">
          <option value="GET" selected>GET</option>
          <option value="POST">POST</option>
          <option value="PUT">PUT</option>
          <option value="PATCH">PATCH</option>
          <option value="DELETE">DELETE</option>
          <option value="HEAD">HEAD</option>
          <option value="OPTIONS">OPTIONS</option>
        </select>
        <div class="help-text">HTTP method for the request</div>
      </div>

      <div class="form-group">
        <label for="timeout">Timeout (seconds)</label>
        <div style="display: flex; align-items: center; gap: 15px;">
          <input
            type="number"
            id="timeout"
            name="timeout"
            value="30"
            min="1"
            max="60"
            step="1"
            autocomplete="off"
          >
          <div class="checkbox-group">
            <input
              type="checkbox"
              id="raise_error_responses"
              name="raise_error_responses"
              value="1"
            >
            <label for="raise_error_responses" style="white-space: nowrap;">Raise HTTP Errors</label>
          </div>
        </div>
        <div class="help-text">Request timeout in seconds</div>
      </div>

      <div class="form-group">
        <div style="display: flex; align-items: center; gap: 8px;">
          <label style="margin: 0;">Headers</label>
          <button type="button" id="add-header-btn" style="width: 20px; height: 20px; padding: 0; font-size: 14px; line-height: 1; cursor: pointer; border-radius: 50%; background: #10b981 !important; color: white !important; border: none; display: flex; align-items: center; justify-content: center;">+</button>
        </div>
        <div id="headers-list" style="margin-top: 10px;"></div>
        <div class="help-text">Enter headers in the format "Name: Value" (e.g., "Content-Type: application/json")</div>
      </div>

      <div class="form-group" id="body-group" style="display: none;">
        <label for="body">Request Body</label>
        <textarea
          id="body"
          name="body"
          rows="6"
          autocomplete="off"
          placeholder="Enter request body..."
        ></textarea>
        <div class="help-text">Request body content</div>
      </div>

      <button type="submit">Send Request</button>
    </form>

    <div class="response-section">
      <div class="response-title">
        <span>Response</span>
        <span class="polling-indicator active" id="polling-status">Polling</span>
      </div>
      <div class="response-content waiting" id="response-content">Waiting for response...</div>
    </div>

    <div class="links">
      <a href="/">Performance Test</a>
      <a href="/sidekiq/async-http" target="_blank">Sidekiq Dashboard</a>
    </div>
  </div>

  <script>
    (function() {
      // Toast notification
      function showToast(message, isError) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.background = isError ? '#ef4444' : '#10b981';
        toast.classList.add('show');

        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }

      // Headers management
      let headerCount = 0;
      const headersList = document.getElementById('headers-list');
      const addHeaderBtn = document.getElementById('add-header-btn');

      function addHeader(value = '') {
        const headerId = `header-${headerCount++}`;
        const headerDiv = document.createElement('div');
        headerDiv.className = 'header-item';
        headerDiv.style.display = 'flex';
        headerDiv.style.gap = '10px';
        headerDiv.style.marginBottom = '10px';
        headerDiv.style.alignItems = 'center';
        headerDiv.innerHTML = `
          <input
            type="text"
            name="headers[]"
            placeholder="Content-Type: application/json"
            value="${value}"
            autocomplete="off"
            style="flex: 1;"
          >
          <button type="button" class="remove-header-btn" style="width: 20px; height: 20px; padding: 0; font-size: 14px; line-height: 1; cursor: pointer; border-radius: 50%; background: #ef4444 !important; color: white !important; border: none; display: flex; align-items: center; justify-content: center;">-</button>
        `;

        const removeBtn = headerDiv.querySelector('.remove-header-btn');
        removeBtn.addEventListener('click', () => {
          headerDiv.remove();
        });

        headersList.appendChild(headerDiv);
      }

      addHeaderBtn.addEventListener('click', () => addHeader());

      // Method change handler for body visibility
      const methodSelect = document.getElementById('method');
      const bodyGroup = document.getElementById('body-group');
      const bodyField = document.getElementById('body');

      function updateBodyVisibility() {
        const method = methodSelect.value;
        const methodsWithBody = ['POST', 'PUT', 'PATCH', 'DELETE'];

        if (methodsWithBody.includes(method)) {
          bodyGroup.style.display = 'block';
        } else {
          bodyGroup.style.display = 'none';
          bodyField.value = ''; // Clear body when hiding
        }
      }

      methodSelect.addEventListener('change', updateBodyVisibility);
      updateBodyVisibility(); // Set initial state

      // Response display
      const responseContent = document.getElementById('response-content');
      const pollingStatus = document.getElementById('polling-status');

      function clearResponse() {
        responseContent.textContent = 'Waiting for response...';
        responseContent.className = 'response-content waiting';
      }

      function displayResponse(data) {
        if (data.response) {
          const parsed = JSON.parse(data.response);
          responseContent.textContent = JSON.stringify(parsed, null, 2);
          if (parsed.error) {
            responseContent.className = 'response-content error';
          } else if (parsed.response) {
            responseContent.className = 'response-content success';
          } else {
            responseContent.className = 'response-content';
          }
          stopPolling();
          pollingStatus.textContent = 'Stopped';
          pollingStatus.className = 'polling-indicator stopped';
          return true; // Response received
        }
        return false; // Still waiting
      }

      // Form submission
      const form = document.getElementById('inspect-form');
      form.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(form);
        const button = form.querySelector('button[type="submit"]');

        button.disabled = true;
        button.textContent = 'Sending...';
        clearResponse();

        fetch('/run_inspect', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (response.ok) {
            const context = formData.get('context');
            const contextLabel = context === 'sidekiq' ? 'from Sidekiq job' : 'outside Sidekiq';
            showToast(`Request sent ${contextLabel}!`);
          } else {
            showToast('Failed to send request', true);
          }
        })
        .catch(err => {
          console.error('Error submitting form:', err);
          showToast('Error submitting form', true);
        })
        .finally(() => {
          button.disabled = false;
          button.textContent = 'Send Request';

          // Start polling after form submission completes
          responseReceived = false;
          noResponseCount = 0;
          if (!isPolling) {
            startPolling();
          }
        });
      });

      // Status polling
      let noResponseCount = 0;
      let responseReceived = false;
      let pollInterval = null;
      let isPolling = false;

      function fetchStatus() {
        fetch('/inspect_status')
          .then(response => response.json())
          .then(data => {
            if (displayResponse(data)) {
              responseReceived = true;
              // Keep polling active for a bit after receiving response
              // in case user wants to see updated responses
            }

            if (!data.response) {
              noResponseCount++;
            } else {
              noResponseCount = 0;
            }

            // Stop polling after 60 seconds of no new response (120 polls at 500ms)
            if (noResponseCount >= 120 && isPolling) {
              stopPolling();
              pollingStatus.textContent = 'Stopped';
              pollingStatus.className = 'polling-indicator stopped';
            }
          })
          .catch(err => console.error('Failed to fetch status:', err));
      }

      function startPolling() {
        if (isPolling) return;

        isPolling = true;
        pollingStatus.textContent = 'Polling';
        pollingStatus.className = 'polling-indicator active';
        fetchStatus(); // Initial fetch
        pollInterval = setInterval(fetchStatus, 500);
      }

      function stopPolling() {
        if (pollInterval) {
          clearInterval(pollInterval);
          pollInterval = null;
        }
        isPolling = false;
      }

      // Stop polling when page is hidden/unloaded
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          stopPolling();
        } else {
          startPolling();
        }
      });
    })();
  </script>
</body>
</html>
